const _={Shafi:"shafi",Hanafi:"hanafi"};function st(t){switch(t){case _.Shafi:return 1;case _.Hanafi:return 2;default:throw"Invalid Madhab"}}const R={MiddleOfTheNight:"middleofthenight",SeventhOfTheNight:"seventhofthenight",TwilightAngle:"twilightangle"};class rt{constructor(n,e){this.latitude=n,this.longitude=e}}const Y={Nearest:"nearest",Up:"up",None:"none"};function F(t,n){const e=t.getFullYear(),s=t.getMonth(),r=t.getDate()+n,o=t.getHours(),i=t.getMinutes(),h=t.getSeconds();return new Date(e,s,r,o,i,h)}function L(t,n){return S(t,n*60)}function S(t,n){return new Date(t.getTime()+n*1e3)}function N(t,n=Y.Nearest){const e=t.getUTCSeconds();let s=e>=30?60-e:-1*e;return n===Y.Up?s=60-e:n===Y.None&&(s=0),S(t,s)}function z(t){let n=0;const s=[31,u.isLeapYear(t.getFullYear())?29:28,31,30,31,30,31,31,30,31,30,31];for(let r=0;r<t.getMonth();r++)n+=s[r];return n+=t.getDate(),n}function J(t){return t instanceof Date&&!isNaN(t.valueOf())}function l(t){return t*Math.PI/180}function I(t){return t*180/Math.PI}function $(t,n){return t-n*Math.floor(t/n)}function M(t){return $(t,360)}function ot(t){return t>=-180&&t<=180?t:t-360*Math.round(t/360)}const k={General:"general",Ahmer:"ahmer",Abyad:"abyad"},u={meanSolarLongitude(t){const n=t,e=280.4664567,s=36000.76983*n,r=3032e-7*Math.pow(n,2),o=e+s+r;return M(o)},meanLunarLongitude(t){const n=t,e=218.3165,s=481267.8813*n,r=e+s;return M(r)},ascendingLunarNodeLongitude(t){const n=t,e=125.04452,s=1934.136261*n,r=.0020708*Math.pow(n,2),o=Math.pow(n,3)/45e4,i=e-s+r+o;return M(i)},meanSolarAnomaly(t){const n=t,e=357.52911,s=35999.05029*n,r=1537e-7*Math.pow(n,2),o=e+s-r;return M(o)},solarEquationOfTheCenter(t,n){const e=t,s=l(n),r=(1.914602-.004817*e-14e-6*Math.pow(e,2))*Math.sin(s),o=(.019993-101e-6*e)*Math.sin(2*s),i=289e-6*Math.sin(3*s);return r+o+i},apparentSolarLongitude(t,n){const e=t,r=n+u.solarEquationOfTheCenter(e,u.meanSolarAnomaly(e)),o=125.04-1934.136*e,i=r-.00569-.00478*Math.sin(l(o));return M(i)},meanObliquityOfTheEcliptic(t){const n=t,e=23.439291,s=.013004167*n,r=1639e-10*Math.pow(n,2),o=5036e-10*Math.pow(n,3);return e-s-r+o},apparentObliquityOfTheEcliptic(t,n){const e=t,s=n,r=125.04-1934.136*e;return s+.00256*Math.cos(l(r))},meanSiderealTime(t){const n=t,e=n*36525+2451545,s=280.46061837,r=360.98564736629*(e-2451545),o=387933e-9*Math.pow(n,2),i=Math.pow(n,3)/3871e4,h=s+r+o-i;return M(h)},nutationInLongitude(t,n,e,s){const r=n,o=e,i=s,h=-17.2/3600*Math.sin(l(i)),g=1.32/3600*Math.sin(2*l(r)),a=.23/3600*Math.sin(2*l(o)),c=.21/3600*Math.sin(2*l(i));return h-g-a+c},nutationInObliquity(t,n,e,s){const r=n,o=e,i=s,h=9.2/3600*Math.cos(l(i)),g=.57/3600*Math.cos(2*l(r)),a=.1/3600*Math.cos(2*l(o)),c=.09/3600*Math.cos(2*l(i));return h+g+a-c},altitudeOfCelestialBody(t,n,e){const s=t,r=n,o=e,i=Math.sin(l(s))*Math.sin(l(r)),h=Math.cos(l(s))*Math.cos(l(r))*Math.cos(l(o));return I(Math.asin(i+h))},approximateTransit(t,n,e){const s=t,r=n,o=e,i=s*-1;return $((o+i-r)/360,1)},correctedTransit(t,n,e,s,r,o){const i=t,h=n,g=e,a=s,c=r,f=o,d=h*-1,w=M(g+360.985647*i),D=M(u.interpolateAngles(a,c,f,i)),C=ot(w-d-D)/-360;return(i+C)*24},correctedHourAngle(t,n,e,s,r,o,i,h,g,a,c){const f=t,d=n,w=r,D=o,y=i,C=h,b=g,q=a,H=c,B=e.longitude*-1,K=Math.sin(l(d))-Math.sin(l(e.latitude))*Math.sin(l(b)),Q=Math.cos(l(e.latitude))*Math.cos(l(b)),E=I(Math.acos(K/Q)),v=s?f+E/360:f-E/360,A=M(w+360.985647*v),O=M(u.interpolateAngles(D,y,C,v)),G=u.interpolate(b,q,H,v),W=A-B-O,tt=u.altitudeOfCelestialBody(e.latitude,G,W)-d,nt=360*Math.cos(l(G))*Math.cos(l(e.latitude))*Math.sin(l(W)),et=tt/nt;return(v+et)*24},interpolate(t,n,e,s){const r=t-n,o=e-t,i=o-r;return t+s/2*(r+o+s*i)},interpolateAngles(t,n,e,s){const r=M(t-n),o=M(e-t),i=o-r;return t+s/2*(r+o+s*i)},julianDay(t,n,e,s=0){const r=Math.trunc,o=r(n>2?t:t-1),i=r(n>2?n:n+12),h=e+s/24,g=r(o/100),a=r(2-g+r(g/4)),c=r(365.25*(o+4716)),f=r(30.6001*(i+1));return c+f+h+a-1524.5},julianCentury(t){return(t-2451545)/36525},isLeapYear(t){return!(t%4!==0||t%100===0&&t%400!==0)},seasonAdjustedMorningTwilight(t,n,e,s){const r=75+.5209090909090909*Math.abs(t),o=75+19.44/55*Math.abs(t),i=75+32.74/55*Math.abs(t),h=75+48.1/55*Math.abs(t),g=(function(){const a=u.daysSinceSolstice(n,e,t);return a<91?r+(o-r)/91*a:a<137?o+(i-o)/46*(a-91):a<183?i+(h-i)/46*(a-137):a<229?h+(i-h)/46*(a-183):a<275?i+(o-i)/46*(a-229):o+(r-o)/91*(a-275)})();return S(s,Math.round(g*-60))},seasonAdjustedEveningTwilight(t,n,e,s,r){let o,i,h,g;r===k.Ahmer?(o=62+17.4/55*Math.abs(t),i=62-7.16/55*Math.abs(t),h=62+5.12/55*Math.abs(t),g=62+19.44/55*Math.abs(t)):r===k.Abyad?(o=75+25.6/55*Math.abs(t),i=75+7.16/55*Math.abs(t),h=75+36.84/55*Math.abs(t),g=75+81.84/55*Math.abs(t)):(o=75+25.6/55*Math.abs(t),i=75+2.05/55*Math.abs(t),h=75-9.21/55*Math.abs(t),g=75+6.14/55*Math.abs(t));const a=(function(){const c=u.daysSinceSolstice(n,e,t);return c<91?o+(i-o)/91*c:c<137?i+(h-i)/46*(c-91):c<183?h+(g-h)/46*(c-137):c<229?g+(h-g)/46*(c-183):c<275?h+(i-h)/46*(c-229):i+(o-i)/91*(c-275)})();return S(s,Math.round(a*60))},daysSinceSolstice(t,n,e){let s=0;const r=10,o=u.isLeapYear(n)?173:172,i=u.isLeapYear(n)?366:365;return e>=0?(s=t+r,s>=i&&(s=s-i)):(s=t-o,s<0&&(s=s+i)),s}};class V{constructor(n){const e=u.julianCentury(n),s=u.meanSolarLongitude(e),r=u.meanLunarLongitude(e),o=u.ascendingLunarNodeLongitude(e),i=l(u.apparentSolarLongitude(e,s)),h=u.meanSiderealTime(e),g=u.nutationInLongitude(e,s,r,o),a=u.nutationInObliquity(e,s,r,o),c=u.meanObliquityOfTheEcliptic(e),f=l(u.apparentObliquityOfTheEcliptic(e,c));this.declination=I(Math.asin(Math.sin(f)*Math.sin(i))),this.rightAscension=M(I(Math.atan2(Math.cos(f)*Math.sin(i),Math.cos(i)))),this.apparentSiderealTime=h+g*3600*Math.cos(l(c+a))/3600}}class j{constructor(n,e){const s=u.julianDay(n.getFullYear(),n.getMonth()+1,n.getDate(),0);this.observer=e,this.solar=new V(s),this.prevSolar=new V(s-1),this.nextSolar=new V(s+1);const r=u.approximateTransit(e.longitude,this.solar.apparentSiderealTime,this.solar.rightAscension),o=-50/60;this.approxTransit=r,this.transit=u.correctedTransit(r,e.longitude,this.solar.apparentSiderealTime,this.solar.rightAscension,this.prevSolar.rightAscension,this.nextSolar.rightAscension),this.sunrise=u.correctedHourAngle(r,o,e,!1,this.solar.apparentSiderealTime,this.solar.rightAscension,this.prevSolar.rightAscension,this.nextSolar.rightAscension,this.solar.declination,this.prevSolar.declination,this.nextSolar.declination),this.sunset=u.correctedHourAngle(r,o,e,!0,this.solar.apparentSiderealTime,this.solar.rightAscension,this.prevSolar.rightAscension,this.nextSolar.rightAscension,this.solar.declination,this.prevSolar.declination,this.nextSolar.declination)}hourAngle(n,e){return u.correctedHourAngle(this.approxTransit,n,this.observer,e,this.solar.apparentSiderealTime,this.solar.rightAscension,this.prevSolar.rightAscension,this.nextSolar.rightAscension,this.solar.declination,this.prevSolar.declination,this.nextSolar.declination)}afternoon(n){const e=Math.abs(this.observer.latitude-this.solar.declination),s=n+Math.tan(l(e)),r=I(Math.atan(1/s));return this.hourAngle(r,!0)}}const U={AqrabBalad:"AqrabBalad",AqrabYaum:"AqrabYaum",Unresolved:"Unresolved"},X=.5,it=65,x=t=>!isNaN(t.sunrise)&&!isNaN(t.sunset),Z=(t,n,e=1,s=1)=>{if(e>Math.ceil(365/2))return null;const r=new Date(n.getTime());r.setDate(r.getDate()+s*e);const o=F(r,1),i=new j(r,t),h=new j(o,t);return!x(i)||!x(h)?Z(t,n,e+(s>0?0:1),-s):{date:n,tomorrow:o,coordinates:t,solarTime:i,tomorrowSolarTime:h}},P=(t,n,e)=>{const s=new j(n,{...t,latitude:e}),r=F(n,1),o=new j(r,{...t,latitude:e});return!x(s)||!x(o)?Math.abs(e)>=it?P(t,n,e-Math.sign(e)*X):null:{date:n,tomorrow:r,coordinates:new rt(e,t.longitude),solarTime:s,tomorrowSolarTime:o}},ht=(t,n,e)=>{const s={date:n,tomorrow:F(n,1),coordinates:e,solarTime:new j(n,e),tomorrowSolarTime:new j(F(n,1),e)};switch(t){case U.AqrabYaum:return Z(e,n)||s;case U.AqrabBalad:{const{latitude:r}=e;return P(e,n,r-Math.sign(r)*X)||s}default:return s}};class p{madhab=_.Shafi;highLatitudeRule=R.MiddleOfTheNight;adjustments={fajr:0,sunrise:0,dhuhr:0,asr:0,maghrib:0,isha:0};methodAdjustments={fajr:0,sunrise:0,dhuhr:0,asr:0,maghrib:0,isha:0};polarCircleResolution=U.Unresolved;rounding=Y.Nearest;shafaq=k.General;constructor(n,e=0,s=0,r=0,o=0){this.method=n,this.fajrAngle=e,this.ishaAngle=s,this.ishaInterval=r,this.maghribAngle=o,this.method===null&&(this.method="Other")}nightPortions(){switch(this.highLatitudeRule){case R.MiddleOfTheNight:return{fajr:1/2,isha:1/2};case R.SeventhOfTheNight:return{fajr:1/7,isha:1/7};case R.TwilightAngle:return{fajr:this.fajrAngle/60,isha:this.ishaAngle/60};default:throw`Invalid high latitude rule found when attempting to compute night portions: ${this.highLatitudeRule}`}}}const ut={MuslimWorldLeague(){const t=new p("MuslimWorldLeague",18,17);return t.methodAdjustments.dhuhr=1,t},Egyptian(){const t=new p("Egyptian",19.5,17.5);return t.methodAdjustments.dhuhr=1,t},Karachi(){const t=new p("Karachi",18,18);return t.methodAdjustments.dhuhr=1,t},UmmAlQura(){return new p("UmmAlQura",18.5,0,90)},Dubai(){const t=new p("Dubai",18.2,18.2);return t.methodAdjustments={...t.methodAdjustments,sunrise:-3,dhuhr:3,asr:3,maghrib:3},t},NorthAmerica(){const t=new p("NorthAmerica",15,15);return t.methodAdjustments.dhuhr=1,t},Kuwait(){return new p("Kuwait",18,17.5)},Qatar(){return new p("Qatar",18,0,90)},Singapore(){const t=new p("Singapore",20,18);return t.methodAdjustments.dhuhr=1,t.rounding=Y.Up,t},Tehran(){return new p("Tehran",17.7,14,0,4.5)},Turkey(){const t=new p("Turkey",18,17);return t.methodAdjustments={...t.methodAdjustments,sunrise:-7,dhuhr:5,asr:4,maghrib:7},t}},m={Fajr:"fajr",Sunrise:"sunrise",Dhuhr:"dhuhr",Asr:"asr",Maghrib:"maghrib",Isha:"isha",None:"none"};class T{constructor(n){return this.hours=Math.floor(n),this.minutes=Math.floor((n-this.hours)*60),this.seconds=Math.floor((n-(this.hours+this.minutes/60))*60*60),this}utcDate(n,e,s){return new Date(Date.UTC(n,e,s,this.hours,this.minutes,this.seconds))}}class ct{constructor(n,e,s){this.coordinates=n,this.date=e,this.calculationParameters=s;let r=new j(e,n),o,i,h,g,a,c,f,d;h=new T(r.transit).utcDate(e.getFullYear(),e.getMonth(),e.getDate()),i=new T(r.sunrise).utcDate(e.getFullYear(),e.getMonth(),e.getDate()),a=new T(r.sunset).utcDate(e.getFullYear(),e.getMonth(),e.getDate());const w=F(e,1);let D=new j(w,n);const y=s.polarCircleResolution;if((!J(i)||!J(a)||isNaN(D.sunrise))&&y!==U.Unresolved){const A=ht(y,e,n);r=A.solarTime,D=A.tomorrowSolarTime;const O=[e.getFullYear(),e.getMonth(),e.getDate()];h=new T(r.transit).utcDate(...O),i=new T(r.sunrise).utcDate(...O),a=new T(r.sunset).utcDate(...O)}g=new T(r.afternoon(st(s.madhab))).utcDate(e.getFullYear(),e.getMonth(),e.getDate());const C=new T(D.sunrise).utcDate(w.getFullYear(),w.getMonth(),w.getDate()),b=(Number(C)-Number(a))/1e3;o=new T(r.hourAngle(-1*s.fajrAngle,!1)).utcDate(e.getFullYear(),e.getMonth(),e.getDate()),s.method==="MoonsightingCommittee"&&n.latitude>=55&&(d=b/7,o=S(i,-d));const q=(function(){return s.method==="MoonsightingCommittee"?u.seasonAdjustedMorningTwilight(n.latitude,z(e),e.getFullYear(),i):(d=s.nightPortions().fajr*b,S(i,-d))})();if((isNaN(o.getTime())||q>o)&&(o=q),s.ishaInterval>0)f=L(a,s.ishaInterval);else{f=new T(r.hourAngle(-1*s.ishaAngle,!0)).utcDate(e.getFullYear(),e.getMonth(),e.getDate()),s.method==="MoonsightingCommittee"&&n.latitude>=55&&(d=b/7,f=S(a,d));const A=(function(){return s.method==="MoonsightingCommittee"?u.seasonAdjustedEveningTwilight(n.latitude,z(e),e.getFullYear(),a,s.shafaq):(d=s.nightPortions().isha*b,S(a,d))})();(isNaN(f.getTime())||A<f)&&(f=A)}if(c=a,s.maghribAngle){const A=new T(r.hourAngle(-1*s.maghribAngle,!0)).utcDate(e.getFullYear(),e.getMonth(),e.getDate());a<A&&f>A&&(c=A)}const H=(s.adjustments.fajr||0)+(s.methodAdjustments.fajr||0),B=(s.adjustments.sunrise||0)+(s.methodAdjustments.sunrise||0),K=(s.adjustments.dhuhr||0)+(s.methodAdjustments.dhuhr||0),Q=(s.adjustments.asr||0)+(s.methodAdjustments.asr||0),E=(s.adjustments.maghrib||0)+(s.methodAdjustments.maghrib||0),v=(s.adjustments.isha||0)+(s.methodAdjustments.isha||0);this.fajr=N(L(o,H),s.rounding),this.sunrise=N(L(i,B),s.rounding),this.dhuhr=N(L(h,K),s.rounding),this.asr=N(L(g,Q),s.rounding),this.sunset=N(a,s.rounding),this.maghrib=N(L(c,E),s.rounding),this.isha=N(L(f,v),s.rounding)}timeForPrayer(n){return n===m.Fajr?this.fajr:n===m.Sunrise?this.sunrise:n===m.Dhuhr?this.dhuhr:n===m.Asr?this.asr:n===m.Maghrib?this.maghrib:n===m.Isha?this.isha:null}currentPrayer(n=new Date){return n>=this.isha?m.Isha:n>=this.maghrib?m.Maghrib:n>=this.asr?m.Asr:n>=this.dhuhr?m.Dhuhr:n>=this.sunrise?m.Sunrise:n>=this.fajr?m.Fajr:m.None}nextPrayer(n=new Date){return n>=this.isha?m.None:n>=this.maghrib?m.Isha:n>=this.asr?m.Maghrib:n>=this.dhuhr?m.Asr:n>=this.sunrise?m.Dhuhr:n>=this.fajr?m.Sunrise:m.Fajr}}export{ut as C,ct as P,rt as a};
